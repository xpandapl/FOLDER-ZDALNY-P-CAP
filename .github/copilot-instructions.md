# P-CAP Assessment System - AI Agent Instructions

## Project Overview
P-CAP is a Laravel 8-based competency assessment platform with hierarchical management (Supervisor â†’ Manager â†’ Head â†’ Supermanager). Employees complete self-assessments through anonymous access codes, while managers evaluate and track team development across assessment cycles.

**Core directory**: `pcap/` contains the main Laravel application (ignore nested `pcap/pcap/` - it's duplicated).

## Architecture & Key Concepts

### Assessment Cycle System
- **Active Cycle**: Only one cycle can be active at a time (`assessment_cycles.is_active`)
- Cycles can be locked (`locked_at`) to prevent further edits
- All results are cycle-scoped via `results.cycle_id`
- Use `AssessmentCycle::where('is_active', true)->value('id')` to get current cycle (never cache this)

### Hierarchical Access Control
Four management tiers with cumulative visibility:
- **Supervisor**: Direct reports only (`employees.supervisor_username`)
- **Manager**: Supervisors + their reports (via `HierarchyStructure`)
- **Head**: Entire department including managers and supervisors
- **Supermanager**: Organization-wide access

**Critical**: Employee relationships are stored in `employees` table (`supervisor_username`, `manager_username`, `head_username`). The `HierarchyStructure` model defines department org charts. Use `Employee::getRelationshipToManager($user)` to check access rights.

### Level Configuration (`config/levels.php`)
**Level 6 is intentionally retired** across the entire system:
- `levels.active`: UI labels (1-5: Junior â†’ Manager)
- `levels.manager`: Dashboard labels with numbering
- `levels.max`: Hard limit at 5
- Historical level 6 data exists in database but is filtered out in views/exports

### Access Code System
Veteran employees authenticate via time-limited access codes:
- Generated by managers per cycle (`employee_cycle_access_codes`)
- Rate-limited by IP hash (`employee_code_attempts`)
- Code format: `{employee_id}-{random_hash}` for active cycle verification

## Critical Patterns

### Middleware & Authorization
- `ManagerMiddleware`: Gates all manager routes - checks role in `['supervisor', 'manager', 'head', 'supermanager']`
- `enforce.active.cycle.manager`: Prevents edits to non-active cycles (exists but check `ManagerController` for usage)
- Admin routes require `auth()->user()->role === 'admin'`

### Manager Controller Structure
Two interfaces coexist:
- **Legacy**: `/manager-panel-old` - original single-page interface
- **Modern**: `/manager-panel` - sidebar navigation with AJAX section loading (see `MANAGER_PANEL_NEW.md`)

Manager methods filter employees via:
```php
$employees = $this->getEmployeesForManager($manager, $selectedCycleId);
$employeesByLevel = $this->groupEmployeesByLevel($employees, $manager);
```

### Competency Value Resolution
**Hierarchical override system** (check `Employee::getCompetencyValue($competencyId)`):
1. Employee-specific override (`employee_competency_values`)
2. Team default (`competency_team_values`)
3. Fall back to 0

Always check overridden values before using team defaults.

### Maintenance Mode Gate
`config('app.maintenance')` in `routes/web.php` blocks ALL routes when enabled. Health check at `/health` still responds.

## Database Key Tables
- `employees`: Staff records with hierarchy columns (`supervisor_username`, `manager_username`, `head_username`)
- `hierarchy_structure`: Department org chart definitions
- `assessment_cycles`: Yearly/half-yearly cycles (`year`, `period`, `is_active`, `locked_at`)
- `results`: Self-assessment scores per competency (`score` = employee, `score_manager` = manager override)
- `competencies`: Question bank with categories
- `employee_cycle_access_codes`: Generated access tokens per employee per cycle
- `users`: Authenticated managers/admins with `role` and `username` columns

## Development Workflows

### âš ï¸ CRITICAL: Production Environment
**This is a LIVE PRODUCTION SYSTEM with active users completing assessments.**
- **FTP auto-sync** deploys all changes IMMEDIATELY to production
- **No build step** - all edits go live instantly (no npm build required)
- **DATABASE IS SACRED** - User assessment data cannot be lost under any circumstances
- Work on multiple environments but be aware changes propagate instantly via FTP

### Running the Application
```bash
# Install dependencies (first time only)
composer install

# Generate application key (local dev only - NEVER on production)
php artisan key:generate

# Run migrations (EXTREME CAUTION - production data is irreplaceable)
php artisan migrate

# Start local server
php artisan serve
```

### Common Admin Tasks
```bash
# Clear all caches (admin-only route exists: /clear-all-cache)
php artisan view:clear
php artisan config:clear
php artisan cache:clear

# Database operations
php artisan tinker  # Interactive shell for testing models

# âš ï¸ NEVER RUN ON PRODUCTION - Will destroy user data:
# php artisan migrate:fresh
# php artisan migrate:fresh --seed
# php artisan db:seed --force
```

### Asset Management
âš ï¸ **No build process** - Assets are served directly from `public/`:
- Edit `public/js/` files directly (no webpack/mix compilation)
- Edit `public/css/` files directly (no sass compilation)
- Changes are instantly live via FTP auto-sync

Blade templates in `resources/views/` use three main layouts:
- `layouts.admin` - Admin panel with sidebar
- `layouts.manager` - Manager panel with modern sidebar (new interface)
- `layouts.self-assessment` - Public assessment forms

### Database Safety Rules
ðŸ”´ **CRITICAL**: Active users are completing assessments. Data loss is catastrophic.
- **Never** use `migrate:fresh`, `migrate:reset`, or `db:seed --force` on production
- **Always** test migrations on local copy before production
- **Backup** database before any schema changes
- **Verify** seeder files won't overwrite production data before running

## Common Pitfalls

1. **FTP auto-deploy means no safety net** - Every file save goes to production instantly. Test thoroughly in local environment first.

2. **MySQL query timeouts are common** - Manager panel and admin panel load massive datasets. Always use:
   - Eager loading with `->with()` to avoid N+1 queries
   - Chunking for large result sets: `->chunk(100, function($items) {...})`
   - Pagination instead of `->get()` for large tables
   - Query optimization: add indexes, select only needed columns

3. **Never cache active cycle ID** - Always query fresh: `AssessmentCycle::where('is_active', true)->value('id')`

4. **Hierarchy visibility is complex** - Don't assume simple role checks. Use `Employee::getRelationshipToManager()` or `ManagerController::getEmployeesForManager()` for filtering.

5. **Competency values cascade** - Check `employee_competency_values` before `competency_team_values`. Don't query competencies directly.

6. **Level 6 is dead** - Filter it out everywhere. Don't re-enable without business approval and removing safeguards in exports/dashboards.

7. **Access codes are cycle-specific** - `employee_cycle_access_codes.cycle_id` must match active cycle. Old codes don't auto-expire but won't validate for new cycles.

8. **Duplicate pcap/ directory** - The nested `pcap/pcap/` contains outdated duplicates. Always work in root `pcap/`.

9. **Database is production-only** - No test database exists. Seeders must be written defensively to never overwrite existing user assessment data.

## Performance Optimization Patterns

**Known Issue**: Manager panel and admin panel frequently hit MySQL query timeout limits due to massive dataset loading.

### Critical Query Optimizations
```php
// âŒ BAD - N+1 queries, will timeout
$employees = Employee::all();
foreach ($employees as $emp) {
    $emp->results; // Triggers separate query per employee
}

// âœ… GOOD - Eager loading
$employees = Employee::with(['results', 'team', 'overriddenCompetencyValues'])
    ->get();

// âœ… BETTER - Eager load with constraints for specific cycle
$employees = Employee::with([
    'results' => function($q) use ($cycleId) {
        $q->where('cycle_id', $cycleId)
          ->select('id', 'employee_id', 'competency_id', 'score', 'score_manager');
    },
    'team:id,name',
    'overriddenCompetencyValues:id,employee_id,competency_id,value'
])->get();

// âœ… BEST - Chunking for very large datasets
Employee::with(['results', 'team'])
    ->chunk(100, function($employees) {
        foreach ($employees as $emp) {
            // Process batch
        }
    });
```

### Manager Panel Performance
Check `ManagerController::getEmployeesForManager()` - uses complex joins and subqueries. When modifying:
- Always test with production-scale data locally
- Use `->select()` to limit columns returned
- Consider caching aggregated statistics with short TTL
- Monitor query log: `DB::enableQueryLog()` / `DB::getQueryLog()`

## Export System
- **PDF**: Uses `barryvdh/laravel-dompdf` for individual reports
- **Excel**: Uses `maatwebsite/excel` with custom `TeamReportExport` class
- Exports filter by selected cycle and respect manager visibility scope
- Access code exports can optionally include full codes (see `ManagerController::exportAccessCodes`)
- âš ï¸ Large exports may timeout - consider chunking or background jobs for >1000 records

## Model Relationships to Remember
```php
Employee -> hasMany(Result)
Employee -> belongsTo(User, 'supervisor_username', 'username')
Employee -> belongsTo(Team, 'department', 'name')
Employee -> hasMany(EmployeeCompetencyValue) // Overrides
Team -> hasMany(CompetencyTeamValue) // Defaults
AssessmentCycle -> hasMany(Result, 'cycle_id')
```

## File Locations for Common Tasks
- Add routes: `routes/web.php`
- Update level logic: `config/levels.php`
- Manager panel views: `resources/views/manager/sections/*.blade.php`
- Self-assessment flow: `app/Http/Controllers/SelfAssessmentController.php`
- Competency management: `app/Http/Controllers/AdminPanelController.php`
- Hierarchy tools: `app/Http/Controllers/Admin/HierarchyController.php`
